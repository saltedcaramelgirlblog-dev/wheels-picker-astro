---
import AuthButtons from './AuthButtons.astro';
import logo from '../assets/wheels-picker-icon-200.png';
---

<div class="nav-bar">
  <nav class="nav-container">
    <div class="nav-left">
      <a href="/" class="nav-brand" aria-label="Home">
        <img src={logo.src} width="200" height="70" alt="Wheels Picker" />
      </a>
    </div>
    <a href="/" class="nav-logo" aria-label="Home">Wheel Picker</a>
    <button id="nav-menu-toggle" class="nav-menu-toggle" aria-expanded="false" aria-controls="nav-menu" aria-label="Open menu">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
    <ul id="nav-menu" class="nav-links nav-right">
      <li><a href="#" class="nav-link" id="new-link">New</a></li>
      <li><a href="#" class="nav-link" id="fullscreen-link">Full Screen</a></li>
      <li><a href="#" class="nav-link" id="settings-link">Settings</a></li>
      <li><a href="#" class="nav-link" id="themes-link">Themes</a></li>
      <li><a href="#" class="nav-link" id="auth-link">Login/SignUp</a></li>
    </ul>
  </nav>
  
  <!-- Auth Modal -->
  <div id="auth-modal" class="auth-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="auth-modal__backdrop" data-close="backdrop"></div>
    <div class="auth-modal__dialog" role="document" aria-labelledby="auth-modal-title">
      <button class="auth-modal__close" id="auth-close" aria-label="Close">Ã—</button>
      <h2 id="auth-modal-title" class="auth-modal__title">Welcome</h2>
      <p class="auth-modal__subtitle">Sign in to continue</p>
      <div id="auth-buttons-slot">
        <AuthButtons />
      </div>
    </div>
  </div>
  
</div>

<style>
  .nav-bar {
    grid-area: nav-bar;
    background-color: #212121;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    padding: 0 16px;
    height: 70px;
    position: relative;
  }
  .nav-links {
    list-style: none;
    display: flex;
    gap: 24px;
    margin: 0;
    padding: 0;
  }
  .nav-container { width: 100%; display: grid; grid-template-columns: 1fr 1fr; align-items: center; }
  .nav-left { display: flex; align-items: center; }
  .nav-right { justify-content: flex-end; }
  .nav-logo { display: none; color: #ffffff; text-decoration: none; font-weight: 800; letter-spacing: 0.5px; }
  .nav-brand { display: inline-flex; align-items: center; }
  .nav-brand img { width: 200px; height: 70px; object-fit: contain; border-radius: 4px; }
  .nav-menu-toggle { display: none; background: transparent; border: none; color: #ffffff; cursor: pointer; }
  .nav-link {
    color: #ffffff;
    text-decoration: none;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 14px;
  }
  .nav-link:hover { text-decoration: underline; }

  /* Auth Modal */
  .auth-modal {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 1000;
  }
  .auth-modal[aria-hidden="false"] {
    display: block;
  }
  .auth-modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
  }
  .auth-modal__dialog {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 92vw;
    max-width: 420px;
    background: #1f1f1f;
    color: #fff;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    padding: 24px;
  }
  .auth-modal__title {
    margin: 0 0 8px;
    font-size: 20px;
  }
  .auth-modal__subtitle {
    margin: 0 0 20px;
    color: #cfcfcf;
    font-size: 14px;
  }
  .auth-modal__close {
    position: absolute;
    top: 8px;
    right: 10px;
    background: transparent;
    border: none;
    color: #bdbdbd;
    font-size: 22px;
    cursor: pointer;
    line-height: 1;
  }
  .auth-modal__close:hover { color: #fff; }

  

  .google-btn {
    width: 100%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 10px 14px;
    background: #ffffff;
    color: #1f1f1f;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }
  .google-btn:hover {
    background: #f5f5f5;
  }
  .google-btn__icon { display: inline-flex; }
  .auth-buttons-slot-wrapper { margin-top: 8px; }

  /* Mobile */
  @media (max-width: 768px) {
    .nav-bar { justify-content: center; min-height: 56px; height: auto; align-items: stretch; }
    .nav-container { grid-template-columns: 1fr auto 1fr; grid-template-rows: auto auto; align-items: center; }
    .nav-left { display: none; }
    .nav-logo { display: block; justify-self: center; }
    .nav-menu-toggle { display: inline-flex; justify-self: end; }
    .nav-links { gap: 12px; }
    /* Transform right links into dropdown that pushes content */
    .nav-links.nav-right {
      position: static;
      grid-column: 1 / -1;
      margin: 8px 12px 0 12px;
      background: #1f1f1f;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px;
      display: none;
      flex-direction: column;
    }
    .nav-links.nav-right.open { display: flex; }
    .nav-links.nav-right .nav-link { display: block; padding: 8px 6px; }
  }
</style>

<script is:inline>
  (function() {
    const authLink = document.getElementById('auth-link');
    const modal = document.getElementById('auth-modal');
    const closeBtn = document.getElementById('auth-close');
    const backdrop = modal ? modal.querySelector('[data-close="backdrop"]') : null;
    const googleBtn = document.getElementById('google-signin');
    let lastActiveElement = null;

    // Mobile menu toggle
    const menuBtn = document.getElementById('nav-menu-toggle');
    const menu = document.getElementById('nav-menu');
    function closeMenu() {
      if (!menuBtn || !menu) return;
      menuBtn.setAttribute('aria-expanded', 'false');
      menu.classList.remove('open');
    }
    menuBtn?.addEventListener('click', () => {
      if (!menuBtn || !menu) return;
      const expanded = menuBtn.getAttribute('aria-expanded') === 'true';
      menuBtn.setAttribute('aria-expanded', String(!expanded));
      menu.classList.toggle('open');
    });
    document.addEventListener('click', (e) => {
      const t = e.target;
      if (!(t instanceof Element)) return;
      if (menu && menu.classList.contains('open')) {
        const withinMenu = t.closest('#nav-menu') || t.closest('#nav-menu-toggle');
        if (!withinMenu) closeMenu();
      }
    });

    function openModal() {
      if (!modal) return;
      lastActiveElement = document.activeElement;
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      requestAnimationFrame(() => {
        (googleBtn || closeBtn)?.focus?.();
      });
    }

    function closeModal() {
      if (!modal) return;
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      if (lastActiveElement && typeof lastActiveElement.focus === 'function') {
        lastActiveElement.focus();
      }
    }

    authLink?.addEventListener('click', (e) => {
      e.preventDefault();
      openModal();
    });
    closeBtn?.addEventListener('click', () => closeModal());
    // Close when clicking overlay background
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
    backdrop?.addEventListener('click', () => closeModal());
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal?.getAttribute('aria-hidden') === 'false') {
        closeModal();
      }
    });

    // Listen to auth events dispatched by AuthButtons and update UI
    document.addEventListener('auth:state', (e) => {
      const detail = (e && /** @type {any} */ (e).detail) || {};
      const isSignedIn = !!detail.isSignedIn;
      const label = document.getElementById('auth-link');
      if (isSignedIn) {
        closeModal();
        if (label) label.textContent = 'Account';
      } else {
        if (label) label.textContent = 'Login/SignUp';
      }
    });

  })();
</script>

